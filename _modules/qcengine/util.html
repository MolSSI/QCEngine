

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">



  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/small-apps.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/themefisher-font.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/style.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/small-apps.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/themefisher-font.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/style.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-WJHQJQF');</script>
<!-- End Google Tag Manager -->
 

</head>

<body class="wy-body-for-nav">

  
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WJHQJQF"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->


<div style="width: 100%" class="qca-header">
<nav class="navbar main-nav navbar-expand-lg p-0 qca-header">
  <div class="container nav-width">
    <div class="logo-width">
    <a class="navbar-brand" href="https://docs.qcarchive.molssi.org"><img src="https://docs.qcarchive.molssi.org/en/latest/_static/images/QCAInfrastructure.png" alt="logo" width=200px></a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav"
      aria-expanded="false" aria-label="Toggle navigation">
      <span class="tf-ion-android-menu"></span>
    </button>
    </div>
      <div class="collapse navbar-collapse" id=navbarNav>
         <ul class="navbar-nav ml-auto">
            <li class=nav-item>
                <a class=nav-link href=https://join.slack.com/t/qcarchive/shared_invite/enQtNDIzNTQ2OTExODk0LTE3MWI0YzBjNzVhNzczNDM0ZTA5MmQ1ODcxYTc0YTA1ZDQ2MTk1NDhlMjhjMmQ0YWYwOGMzYzJkZTM2NDlmOGM>
                Community Slack
                </a>
            </li>
            <li class=nav-item><a class=nav-link href=https://qcarchive.molssi.org></a></li>
            <li class="nav-item dropdown dropdown-slide">
               <a class=nav-link href=# data-toggle=dropdown>GitHub
               <span><i class=tf-ion-ios-arrow-down></i></span></a>
               <div class=dropdown-menu>
                  <a class=dropdown-item href=https://github.com/MolSSI/QCElemental>QCElemental</a>
                  <a class=dropdown-item href=https://github.com/MolSSI/QCEngine>QCEngine</a>
                  <a class=dropdown-item href=https://github.com/MolSSI/QCFractal>QCFractal</a>
                  <a class=dropdown-item href=https://github.com/MolSSI/QCFractal>QCPortal</a>
               </div>
            </li>
            <li class="nav-item dropdown dropdown-slide">
               <a class=nav-link href=# data-toggle=dropdown>Documentation
               <span><i class=tf-ion-ios-arrow-down></i></span></a>
               <div class=dropdown-menu>
                  <a class=dropdown-item href=https://docs.qcarchive.molssi.org/>Examples</a>
                  <a class=dropdown-item href=https://docs.qcarchive.molssi.org/projects/QCElemental/en/stable>QCElemental</a>
                  <a class=dropdown-item href=https://docs.qcarchive.molssi.org/projects/QCEngine/en/stable>QCEngine</a>
                  <a class=dropdown-item href=https://docs.qcarchive.molssi.org/projects/QCFractal/en/stable>QCFractal</a>
                  <a class=dropdown-item href=https://docs.qcarchive.molssi.org/projects/QCPortal/en/stable>QCPortal</a>
               </div>
            </li>
            <li class=nav-item><a class=nav-link href=https://qcarchive.molssi.org/><u>MolSSI Database</u></a></li>
         </ul>
      </div>
   </div>
   </div>
</nav>




  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> QCEngine
          

          
          </a>

          
            
            
              <div class="version">
                0+untagged.1.ge248d2f
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Install QCEngine</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Interface</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../single_compute.html">Single Compute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../environment.html">Environment Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">Command Line Interface</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Programs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../program_overview.html">Program Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../programs_semiempirical.html">Semiempirical Quantum Mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../programs_molecular_mechanics.html">Molecular Mechanics</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">QCEngine API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">QCEngine</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>qcengine.util</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for qcengine.util</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Several import utilities</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">BinaryIO</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">TextIO</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">qcelemental.models</span> <span class="kn">import</span> <span class="n">FailedOperation</span>

<span class="kn">from</span> <span class="nn">qcengine.config</span> <span class="kn">import</span> <span class="n">TaskConfig</span>

<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">LOGGER</span><span class="p">,</span> <span class="n">get_provenance_augments</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">InputError</span><span class="p">,</span> <span class="n">QCEngineException</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;compute_wrapper&quot;</span><span class="p">,</span> <span class="s2">&quot;model_wrapper&quot;</span><span class="p">,</span> <span class="s2">&quot;handle_output_metadata&quot;</span><span class="p">,</span> <span class="s2">&quot;create_mpi_invocation&quot;</span><span class="p">,</span> <span class="s2">&quot;execute&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="create_mpi_invocation"><a class="viewcode-back" href="../../api/qcengine.util.create_mpi_invocation.html#qcengine.util.create_mpi_invocation">[docs]</a><span class="k">def</span> <span class="nf">create_mpi_invocation</span><span class="p">(</span><span class="n">executable</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">task_config</span><span class="p">:</span> <span class="n">TaskConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Create the launch command for an MPI-parallel task</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">       executable: str</span>
<span class="sd">           Path to executable</span>
<span class="sd">       task_config: TaskConfig</span>
<span class="sd">           Specification for number of nodes, cores per node, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Make the mpirun invocation</span>
    <span class="n">mpirun_str</span> <span class="o">=</span> <span class="n">task_config</span><span class="o">.</span><span class="n">mpiexec_command</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">nnodes</span><span class="o">=</span><span class="n">task_config</span><span class="o">.</span><span class="n">nnodes</span><span class="p">,</span>
        <span class="n">ranks_per_node</span><span class="o">=</span><span class="n">task_config</span><span class="o">.</span><span class="n">ncores</span> <span class="o">//</span> <span class="n">task_config</span><span class="o">.</span><span class="n">cores_per_rank</span><span class="p">,</span>
        <span class="n">total_ranks</span><span class="o">=</span><span class="n">task_config</span><span class="o">.</span><span class="n">nnodes</span> <span class="o">*</span> <span class="n">task_config</span><span class="o">.</span><span class="n">ncores</span> <span class="o">//</span> <span class="n">task_config</span><span class="o">.</span><span class="n">cores_per_rank</span><span class="p">,</span>
        <span class="n">cores_per_rank</span><span class="o">=</span><span class="n">task_config</span><span class="o">.</span><span class="n">cores_per_rank</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">command</span> <span class="o">=</span> <span class="n">mpirun_str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="c1"># Add in the desired executable</span>
    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">executable</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">command</span></div>


<div class="viewcode-block" id="model_wrapper"><a class="viewcode-back" href="../../api/qcengine.util.model_wrapper.html#qcengine.util.model_wrapper">[docs]</a><span class="k">def</span> <span class="nf">model_wrapper</span><span class="p">(</span><span class="n">input_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;BaseModel&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;BaseModel&quot;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrap input data in the given model, or return a controlled error</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">input_data</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error creating &#39;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;, data could not be correctly parsed:</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="n">input_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s2">&quot;Input type of </span><span class="si">{}</span><span class="s2"> not understood.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)))</span>

    <span class="c1"># Older QCElemental compat</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">input_data</span><span class="o">.</span><span class="n">extras</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="n">input_data</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;extras&quot;</span><span class="p">:</span> <span class="p">{}})</span>

    <span class="k">return</span> <span class="n">input_data</span></div>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">capture_stdout</span><span class="p">():</span>
    <span class="n">oldout</span><span class="p">,</span> <span class="n">olderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(),</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()]</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">yield</span> <span class="n">out</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">oldout</span><span class="p">,</span> <span class="n">olderr</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>


<div class="viewcode-block" id="compute_wrapper"><a class="viewcode-back" href="../../api/qcengine.util.compute_wrapper.html#qcengine.util.compute_wrapper">[docs]</a><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">compute_wrapper</span><span class="p">(</span><span class="n">capture_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">raise_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Wraps compute for timing, output capturing, and raise protection&quot;&quot;&quot;</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;retries&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="c1"># Start timer</span>
    <span class="n">comp_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Capture stdout/err</span>
    <span class="n">new_stdout</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">new_stderr</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">capture_output</span><span class="p">:</span>

        <span class="n">old_stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">new_stdout</span>
        <span class="n">old_stderr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">new_stderr</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">metadata</span>

    <span class="c1"># Canonical QCEngine, do not show traceback - return error</span>
    <span class="k">except</span> <span class="n">QCEngineException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">raise_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span>

        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">error_type</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;error_message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">error_message</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Unknown QCEngine exception likely in the Python layer, show traceback</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">raise_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span>

        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;unknown_error&quot;</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;error_message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;QCEngine Execution Error:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Place data</span>
    <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;wall_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">comp_time</span>
    <span class="k">if</span> <span class="n">capture_output</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">old_stdout</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">old_stderr</span>
        <span class="c1"># Pull over values</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;stdout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_stdout</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;stderr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_stderr</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="handle_output_metadata"><a class="viewcode-back" href="../../api/qcengine.util.handle_output_metadata.html#qcengine.util.handle_output_metadata">[docs]</a><span class="k">def</span> <span class="nf">handle_output_metadata</span><span class="p">(</span>
    <span class="n">output_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="s2">&quot;BaseModel&quot;</span><span class="p">],</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">raise_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_dict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="s2">&quot;BaseModel&quot;</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fuses general metadata and output together.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : dict or pydantic.models.AtomicResult</span>
<span class="sd">        Output type depends on return_dict or a dict if an error was generated in model construction</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">output_fusion</span> <span class="o">=</span> <span class="n">output_data</span>  <span class="c1"># Error handling</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_fusion</span> <span class="o">=</span> <span class="n">output_data</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>

    <span class="c1"># Do not override if computer generates</span>
    <span class="n">output_fusion</span><span class="p">[</span><span class="s2">&quot;stdout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_fusion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stdout&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;stdout&quot;</span><span class="p">]</span>
    <span class="n">output_fusion</span><span class="p">[</span><span class="s2">&quot;stderr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_fusion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stderr&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;stderr&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">output_fusion</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">output_fusion</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">],</span> <span class="s2">&quot;error_message&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;error_message&quot;</span><span class="p">]}</span>

    <span class="c1"># Raise an error if one exists and a user requested a raise</span>
    <span class="k">if</span> <span class="n">raise_error</span> <span class="ow">and</span> <span class="p">(</span><span class="n">output_fusion</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;stdout:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_fusion</span><span class="p">[</span><span class="s2">&quot;stdout&quot;</span><span class="p">])</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">stderr:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_fusion</span><span class="p">[</span><span class="s2">&quot;stderr&quot;</span><span class="p">])</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">output_fusion</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">][</span><span class="s2">&quot;error_message&quot;</span><span class="p">])</span>

    <span class="c1"># Fill out provenance datadata</span>
    <span class="n">provenance_augments</span> <span class="o">=</span> <span class="n">get_provenance_augments</span><span class="p">()</span>
    <span class="n">provenance_augments</span><span class="p">[</span><span class="s2">&quot;wall_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;wall_time&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;provenance&quot;</span> <span class="ow">in</span> <span class="n">output_fusion</span><span class="p">:</span>
        <span class="n">output_fusion</span><span class="p">[</span><span class="s2">&quot;provenance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">provenance_augments</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Add onto the augments with some missing info</span>
        <span class="n">provenance_augments</span><span class="p">[</span><span class="s2">&quot;creator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;QCEngine&quot;</span>
        <span class="n">provenance_augments</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">provenance_augments</span><span class="p">[</span><span class="s2">&quot;qcengine_version&quot;</span><span class="p">]</span>
        <span class="n">output_fusion</span><span class="p">[</span><span class="s2">&quot;provenance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">provenance_augments</span>

    <span class="k">if</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;retries&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">output_fusion</span><span class="p">[</span><span class="s2">&quot;provenance&quot;</span><span class="p">][</span><span class="s2">&quot;retries&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;retries&quot;</span><span class="p">]</span>

    <span class="c1"># Make sure pydantic sparsity is upheld</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;stdout&quot;</span><span class="p">,</span> <span class="s2">&quot;stderr&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">output_fusion</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_fusion</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="c1"># We need to return the correct objects; e.g. Results, Procedures</span>
    <span class="k">if</span> <span class="n">output_fusion</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
        <span class="c1"># This will only execute if everything went well</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">output_data</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">output_fusion</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Should only be reachable on failures</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">FailedOperation</span><span class="p">(</span>
            <span class="n">success</span><span class="o">=</span><span class="n">output_fusion</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="n">error</span><span class="o">=</span><span class="n">output_fusion</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">),</span> <span class="n">input_data</span><span class="o">=</span><span class="n">output_fusion</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">return_dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>  <span class="c1"># Use Pydantic to serialize, then reconstruct as Python dict of Python Primals</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<span class="k">def</span> <span class="nf">terminate_process</span><span class="p">(</span><span class="n">proc</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># Sigint (keyboard interupt)</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;win&quot;</span><span class="p">):</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">CTRL_BREAK_EVENT</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">)):</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>

        <span class="c1"># Flat kill</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">popen</span><span class="p">(</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">append_prefix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">popen_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pass_output_forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Opens a background task</span>

<span class="sd">    Code and idea from dask.distributed&#39;s testing suite</span>
<span class="sd">    https://github.com/dask/distributed</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        args: List[str]</span>
<span class="sd">            Input arguments for the command</span>
<span class="sd">        append_prefix: bool</span>
<span class="sd">            Whether to prepend the Python path prefix to the command being executed</span>
<span class="sd">        popen_kwargs: Dict[str, Any]</span>
<span class="sd">            Any keyword arguments to use when launching the process</span>
<span class="sd">        pass_output_forward: bool</span>
<span class="sd">            Whether to pass the stdout and stderr forward to the system&#39;s stdout and stderr</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        exe: dict</span>
<span class="sd">            Dictionary with the following keys:</span>
<span class="sd">            &lt;ul&gt;</span>
<span class="sd">                &lt;li&gt;proc: Popen object describing the background task&lt;/li&gt;</span>
<span class="sd">                &lt;li&gt;stdout: String value of the standard output of the task&lt;/li&gt;</span>
<span class="sd">                &lt;li&gt;stdeer: String value of the standard error of the task&lt;/li&gt;</span>
<span class="sd">            &lt;/ul&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">popen_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">popen_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">popen_kwargs</span> <span class="o">=</span> <span class="n">popen_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Bin prefix</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;win&quot;</span><span class="p">):</span>
        <span class="n">bin_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;Scripts&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bin_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;bin&quot;</span><span class="p">)</span>

    <span class="c1"># Do we prefix with Python?</span>
    <span class="k">if</span> <span class="n">append_prefix</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bin_prefix</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;win&quot;</span><span class="p">):</span>
        <span class="c1"># Allow using CTRL_C_EVENT / CTRL_BREAK_EVENT</span>
        <span class="n">popen_kwargs</span><span class="p">[</span><span class="s2">&quot;creationflags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CREATE_NEW_PROCESS_GROUP</span>

    <span class="c1"># Route the standard error and output</span>
    <span class="n">popen_kwargs</span><span class="p">[</span><span class="s2">&quot;stdout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
    <span class="n">popen_kwargs</span><span class="p">[</span><span class="s2">&quot;stderr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>

    <span class="c1"># Prepare StringIO objects to store the stdout and stderr</span>
    <span class="n">stdout</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">stderr</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>

    <span class="c1"># Launch the process</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Popen&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">popen_kwargs</span><span class="p">)</span>

    <span class="c1"># Ready the output</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;proc&quot;</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">popen_kwargs</span><span class="p">)}</span>

    <span class="c1"># Spawn threads that will read from the stderr/stdout</span>
    <span class="c1">#  The PIPE uses a buffer with finite capacity. The underlying</span>
    <span class="c1">#  process will stall if it is unable to write to the buffer</span>
    <span class="c1">#  because the buffer is full. These threads continuously read</span>
    <span class="c1">#  from the buffers to ensure that they do not fill.</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">read_from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">:</span> <span class="n">BinaryIO</span><span class="p">,</span> <span class="n">storage</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">,</span> <span class="n">sysio</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="n">storage</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pass_output_forward</span><span class="p">:</span>
                <span class="n">sysio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>

    <span class="n">stdout_reader</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">read_from_buffer</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="s2">&quot;proc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">))</span>
    <span class="n">stdout_reader</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">stderr_reader</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">read_from_buffer</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="s2">&quot;proc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">))</span>
    <span class="n">stderr_reader</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Yield control back to the main thread</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">ret</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">raise</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Executes on an exception or once the context manager closes</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">terminate_process</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="s2">&quot;proc&quot;</span><span class="p">])</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Wait for the reader threads to finish</span>
            <span class="n">stdout_reader</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="n">stderr_reader</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

            <span class="c1"># Retrieve the standard output for the process</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;stdout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;stderr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stderr</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">environ_context</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;TaskConfig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Temporarily set environment variables inside the context manager and</span>
<span class="sd">    fully restore previous environment afterwards.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : Optional[TaskConfig], optional</span>
<span class="sd">        Automatically sets MKL/OMP num threads based off the input config.</span>
<span class="sd">    env : Optional[Dict[str, str]], optional</span>
<span class="sd">        A dictionary of environment variables to update.</span>

<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    Dict[str, str]</span>
<span class="sd">        The updated environment variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">temporary_env</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">temporary_env</span><span class="p">[</span><span class="s2">&quot;OMP_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">ncores</span><span class="p">)</span>
        <span class="n">temporary_env</span><span class="p">[</span><span class="s2">&quot;MKL_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">ncores</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">env</span><span class="p">:</span>
        <span class="n">temporary_env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

    <span class="n">original_env</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">temporary_env</span><span class="p">}</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">temporary_env</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">temporary_env</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">original_env</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


<div class="viewcode-block" id="execute"><a class="viewcode-back" href="../../api/qcengine.util.execute.html#qcengine.util.execute">[docs]</a><span class="k">def</span> <span class="nf">execute</span><span class="p">(</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">infiles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">outfiles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">as_binary</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">scratch_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">scratch_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">scratch_suffix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">scratch_messy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">scratch_exist_ok</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">blocking_files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">interupt_after</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">environment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">shell</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">exit_code</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs a process in the background until complete.</span>

<span class="sd">    Returns True if exit code &lt;= exit_code (default 0)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    command : list of str</span>
<span class="sd">    infiles : Dict[str] = str</span>
<span class="sd">        Input file names (names, not full paths) and contents.</span>
<span class="sd">        to be written in scratch dir. May be {}.</span>
<span class="sd">    outfiles : List[str] = None</span>
<span class="sd">        Output file names to be collected after execution into</span>
<span class="sd">        values. May be {}.</span>
<span class="sd">    as_binary : List[str] = None</span>
<span class="sd">        Keys of `infiles` or `outfiles` to be treated as bytes.</span>
<span class="sd">    scratch_name : str, optional</span>
<span class="sd">        Passed to temporary_directory</span>
<span class="sd">    scratch_directory : str, optional</span>
<span class="sd">        Passed to temporary_directory</span>
<span class="sd">    scratch_suffix : str, optional</span>
<span class="sd">        Passed to temporary_directory</span>
<span class="sd">    scratch_messy : bool, optional</span>
<span class="sd">        Passed to temporary_directory</span>
<span class="sd">    scratch_exist_ok : bool, optional</span>
<span class="sd">        Passed to temporary_directory</span>
<span class="sd">    blocking_files : list, optional</span>
<span class="sd">        Files which should stop execution if present beforehand.</span>
<span class="sd">    timeout : int, optional</span>
<span class="sd">        Stop the process after n seconds.</span>
<span class="sd">    interupt_after : int, optional</span>
<span class="sd">        Interupt the process (not hard kill) after n seconds.</span>
<span class="sd">    environment : dict, optional</span>
<span class="sd">        The environment to run in</span>
<span class="sd">    shell : bool, optional</span>
<span class="sd">        Run command through the shell.</span>
<span class="sd">    exit_code: int, optional</span>
<span class="sd">        The exit code above which the process is considered failure.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileExistsError</span>
<span class="sd">        If any file in `blocking` is present</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    # execute multiple commands in same dir</span>
<span class="sd">    &gt;&gt;&gt; success, dexe = qcng.util.execute([&#39;command_1&#39;], infiles, [], scratch_messy=True)</span>
<span class="sd">    &gt;&gt;&gt; success, dexe = qcng.util.execute([&#39;command_2&#39;], {}, outfiles, scratch_messy=False, scratch_name=Path(dexe[&#39;scratch_directory&#39;]).name, scratch_exist_ok=True)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Format inputs</span>
    <span class="k">if</span> <span class="n">infiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">infiles</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">outfiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outfiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">outfiles</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">outfiles</span><span class="p">}</span>

    <span class="c1"># Check for blocking files</span>
    <span class="k">if</span> <span class="n">blocking_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">fl</span> <span class="ow">in</span> <span class="n">blocking_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fl</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="s2">&quot;Existing file can interfere with execute operation.&quot;</span><span class="p">,</span> <span class="n">fl</span><span class="p">)</span>

    <span class="c1"># Format popen</span>
    <span class="n">popen_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">popen_kwargs</span><span class="p">[</span><span class="s2">&quot;env&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">environment</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

    <span class="c1"># Execute</span>
    <span class="k">with</span> <span class="n">temporary_directory</span><span class="p">(</span>
        <span class="n">child</span><span class="o">=</span><span class="n">scratch_name</span><span class="p">,</span>
        <span class="n">parent</span><span class="o">=</span><span class="n">scratch_directory</span><span class="p">,</span>
        <span class="n">messy</span><span class="o">=</span><span class="n">scratch_messy</span><span class="p">,</span>
        <span class="n">exist_ok</span><span class="o">=</span><span class="n">scratch_exist_ok</span><span class="p">,</span>
        <span class="n">suffix</span><span class="o">=</span><span class="n">scratch_suffix</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">scrdir</span><span class="p">:</span>
        <span class="n">popen_kwargs</span><span class="p">[</span><span class="s2">&quot;cwd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scrdir</span>
        <span class="n">popen_kwargs</span><span class="p">[</span><span class="s2">&quot;shell&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shell</span>
        <span class="k">with</span> <span class="n">disk_files</span><span class="p">(</span><span class="n">infiles</span><span class="p">,</span> <span class="n">outfiles</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">scrdir</span><span class="p">,</span> <span class="n">as_binary</span><span class="o">=</span><span class="n">as_binary</span><span class="p">)</span> <span class="k">as</span> <span class="n">extrafiles</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">popen_kwargs</span><span class="o">=</span><span class="n">popen_kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">proc</span><span class="p">:</span>
                <span class="c1"># Wait for the subprocess to complete or the timeout to expire</span>
                <span class="k">if</span> <span class="n">interupt_after</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">proc</span><span class="p">[</span><span class="s2">&quot;proc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interupt_after</span><span class="p">)</span>
                    <span class="n">terminate_process</span><span class="p">(</span><span class="n">proc</span><span class="p">[</span><span class="s2">&quot;proc&quot;</span><span class="p">])</span>
            <span class="n">retcode</span> <span class="o">=</span> <span class="n">proc</span><span class="p">[</span><span class="s2">&quot;proc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
        <span class="n">proc</span><span class="p">[</span><span class="s2">&quot;outfiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extrafiles</span>
    <span class="n">proc</span><span class="p">[</span><span class="s2">&quot;scratch_directory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scrdir</span>

    <span class="k">return</span> <span class="n">retcode</span> <span class="o">&lt;=</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">proc</span></div>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">temporary_directory</span><span class="p">(</span>
    <span class="n">child</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">messy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">exist_ok</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create and cleanup a quarantined working directory with a parent scratch directory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    child : str, optional</span>
<span class="sd">        By default, `None`, quarantine directory generated through</span>
<span class="sd">        `tempfile.mdktemp` so guaranteed unique and safe. When specified,</span>
<span class="sd">        quarantine directory has exactly `name`.</span>
<span class="sd">    parent : str, optional</span>
<span class="sd">        Create directory `child` elsewhere than TMP default.</span>
<span class="sd">        For TMP default, see https://docs.python.org/3/library/tempfile.html#tempfile.gettempdir</span>
<span class="sd">    suffix : str, optional</span>
<span class="sd">        Create `child` with identifying label by passing to ``tempfile.mkdtemp``.</span>
<span class="sd">        Encouraged use for debugging only.</span>
<span class="sd">    messy : bool, optional</span>
<span class="sd">        Leave scratch directory and contents on disk after completion.</span>
<span class="sd">    exist_ok : bool, optional</span>
<span class="sd">        Run commands in a possibly pre-existing directory.</span>

<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    str</span>
<span class="sd">        Full path of scratch directory.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileExistsError</span>
<span class="sd">        If `child` specified and directory already exists (perhaps from a</span>
<span class="sd">        previous `messy=True` run).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    parent            child     suffix   --&gt;  creates</span>
<span class="sd">    ------            -----     ------        -------</span>
<span class="sd">    None              None      None     --&gt;  /tmp/tmpliyp1i7x/</span>
<span class="sd">    None              None      _anharm  --&gt;  /tmp/tmpliyp1i7x_anharm/</span>
<span class="sd">    None              myqcjob   None     --&gt;  /tmp/myqcjob/</span>
<span class="sd">    /scratch/johndoe  None      None     --&gt;  /scratch/johndoe/tmpliyp1i7x/</span>
<span class="sd">    /scratch/johndoe  myqcjob   None     --&gt;  /scratch/johndoe/myqcjob/</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">child</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">parent</span> <span class="o">/</span> <span class="n">child</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exist_ok</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">tmpdir</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">messy</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;... Removing </span><span class="si">{</span><span class="n">tmpdir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">disk_files</span><span class="p">(</span>
    <span class="n">infiles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span>
    <span class="n">outfiles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">as_binary</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Write and collect files.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    infiles : Dict[str] = str</span>
<span class="sd">        Input file names (names, not full paths) and contents.</span>
<span class="sd">        to be written in scratch dir. May be {}.</span>
<span class="sd">    outfiles : Dict[str] = None</span>
<span class="sd">        Output file names to be collected after execution into</span>
<span class="sd">        values. May be {}.</span>
<span class="sd">    cwd : str, optional</span>
<span class="sd">        Directory to which to write and read files.</span>
<span class="sd">    as_binary : List[str] = None</span>
<span class="sd">        Keys in `infiles` (`outfiles`) to be written (read) as bytes, not decoded.</span>

<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    Dict[str] = str</span>
<span class="sd">        outfiles with RHS filled in.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cwd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lwd</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lwd</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">as_binary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">as_binary</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">as_binary</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">infiles</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">outfiles</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">fl</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">infiles</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">omode</span> <span class="o">=</span> <span class="s2">&quot;wb&quot;</span> <span class="k">if</span> <span class="n">fl</span> <span class="ow">in</span> <span class="n">as_binary</span> <span class="k">else</span> <span class="s2">&quot;w&quot;</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">lwd</span> <span class="o">/</span> <span class="n">fl</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">omode</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;... Writing (</span><span class="si">{</span><span class="n">omode</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">outfiles</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">fl</span> <span class="ow">in</span> <span class="n">outfiles</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">omode</span> <span class="o">=</span> <span class="s2">&quot;rb&quot;</span> <span class="k">if</span> <span class="n">fl</span> <span class="ow">in</span> <span class="n">as_binary</span> <span class="k">else</span> <span class="s2">&quot;r&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">lwd</span> <span class="o">/</span> <span class="n">fl</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">omode</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                    <span class="n">outfiles</span><span class="p">[</span><span class="n">fl</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;... Writing (</span><span class="si">{</span><span class="n">omode</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">fl</span><span class="p">:</span>
                    <span class="n">gfls</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">gfl</span> <span class="ow">in</span> <span class="n">lwd</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">fl</span><span class="p">):</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gfl</span><span class="p">,</span> <span class="n">omode</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                            <span class="n">gfls</span><span class="p">[</span><span class="n">gfl</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;... Writing (</span><span class="si">{</span><span class="n">omode</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">gfl</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">gfls</span><span class="p">:</span>
                        <span class="n">gfls</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">outfiles</span><span class="p">[</span><span class="n">fl</span><span class="p">]</span> <span class="o">=</span> <span class="n">gfls</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outfiles</span><span class="p">[</span><span class="n">fl</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2018-2021, The Molecular Sciences Software Institute.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>